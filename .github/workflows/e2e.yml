name: E2E Tests

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: onlypaws
          POSTGRES_PASSWORD: onlypaws_dev
          POSTGRES_DB: onlypaws_development
        options: >-
          --health-cmd "pg_isready -U onlypaws" --health-interval 10s --health-timeout 5s --health-retries 5
    env:
      DATABASE_URL: postgresql://onlypaws:onlypaws_dev@localhost:5432/onlypaws_development
      NUXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
      NUXT_CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
      GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
      - run: npm ci
      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            nc -z localhost 5432 && echo "Postgres is up" && break
            echo "Waiting for Postgres..."
            sleep 2
          done
      - name: Run Prisma migrations
        run: npm run prisma:migrate
      - name: Seed database
        run: npm run prisma:seed
      - name: Run E2E tests
        run: npm run test:e2e
